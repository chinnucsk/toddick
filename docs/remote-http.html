<!DOCTYPE html>  <html> <head>   <title>remote-http.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="activity.html">                 activity.js               </a>                                           <a class="source" href="dispatch.html">                 dispatch.js               </a>                                           <a class="source" href="log.html">                 log.js               </a>                                           <a class="source" href="registry.html">                 registry.js               </a>                                           <a class="source" href="remote-http.html">                 remote-http.js               </a>                                           <a class="source" href="timer.html">                 timer.js               </a>                                           <a class="source" href="toddick.html">                 toddick.js               </a>                                           <a class="source" href="when.html">                 when.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               remote-http.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">toddick</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;toddick&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;toddick/lib/timer&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">activity</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;toddick/lib/activity&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">os</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">remote</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>

<span class="nx">remote</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
<span class="nx">remote</span><span class="p">.</span><span class="nx">default_port</span> <span class="o">=</span> <span class="mi">8090</span><span class="p">;</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;Portal&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">port</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">port</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">port</span> <span class="o">=</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">default_port</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">published</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">proxied</span> <span class="o">=</span> <span class="p">{};</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">server</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span> <span class="k">new</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span> <span class="nx">port</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">self</span> <span class="p">)</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">proxy_factory</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span> <span class="k">new</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">ProxyFactory</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">self</span> <span class="p">)</span> <span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">url_base</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">hostname</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span> <span class="s1">&#39;initialized&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">url</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url_base</span> <span class="p">}</span> <span class="p">);</span>
      
    <span class="p">},</span>
    
    <span class="nx">PUBLISH</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">MSG</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s1">&#39;/&#39;</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="nx">instance</span><span class="p">.</span><span class="nx">proxy_def</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">is_toddick_proxy</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url_base</span> <span class="o">+</span> <span class="nx">path</span><span class="p">,</span>
        <span class="nx">messages</span><span class="o">:</span> <span class="p">[]</span>
      <span class="p">};</span>
      
      <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="nx">name</span> <span class="o">!=</span> <span class="s1">&#39;EXIT&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span> <span class="o">!=</span> <span class="s1">&#39;MONITOR_ADD&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span> <span class="o">!=</span> <span class="s1">&#39;MONITOR_REMOVE&#39;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
          <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">msg</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">is_toddick_message</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">instance</span><span class="p">.</span><span class="nx">proxy_def</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">name</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">published</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">MSG</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">MSG</span><span class="p">();</span>
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">UNPUBLISH</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">path</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s1">&#39;/&#39;</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">published</span><span class="p">[</span> <span class="nx">path</span> <span class="p">];</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">published</span><span class="p">[</span> <span class="nx">path</span> <span class="p">];</span>
        <span class="k">delete</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">proxy_def</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
          <span class="k">if</span><span class="p">(</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">is_toddick_message</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">proxy_def</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">GET_PUBLISHED</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">MSG</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s1">&#39;/&#39;</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="nx">MSG</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">published</span><span class="p">[</span> <span class="nx">path</span> <span class="p">]</span> <span class="p">);</span>
      
    <span class="p">},</span>

    <span class="nx">PROXY</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">MSG</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">url</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">def</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">def</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxied</span><span class="p">[</span> <span class="nx">url</span> <span class="p">];</span>
      <span class="k">if</span><span class="p">(</span> <span class="nx">proxy</span> <span class="p">)</span> <span class="p">{</span>
        
        <span class="nx">MSG</span><span class="p">(</span> <span class="nx">proxy</span> <span class="p">);</span>
        
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        
        <span class="k">if</span><span class="p">(</span> <span class="nx">def</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">proxy_factory</span><span class="p">.</span><span class="nx">PROXY_FROM_DEF</span><span class="p">(</span> 
            <span class="k">this</span><span class="p">.</span><span class="nx">PROXY_CREATED</span><span class="p">.</span><span class="nx">withArgs</span><span class="p">(</span> <span class="nx">def</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">MSG</span> <span class="p">),</span>
            <span class="nx">def</span>
          <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">proxy_factory</span><span class="p">.</span><span class="nx">PROXY_FROM_URL</span><span class="p">(</span> 
            <span class="nx">url</span><span class="p">,</span> 
            <span class="k">this</span><span class="p">.</span><span class="nx">PROXY_CREATED</span><span class="p">.</span><span class="nx">withArgs</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">MSG</span> <span class="p">)</span>
          <span class="p">);</span>
        <span class="p">}</span>
        
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">PROXY_CREATED</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">MSG</span><span class="p">,</span> <span class="nx">proxy</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">proxied</span><span class="p">[</span> <span class="nx">url</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">proxy</span><span class="p">;</span>
      <span class="nx">MSG</span><span class="p">(</span> <span class="nx">proxy</span> <span class="p">);</span>
    <span class="p">}</span>
    
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;Server&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">portal</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listener_supervisor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">Supervisor</span><span class="p">(</span>
          <span class="p">{</span>
            <span class="nx">toddick</span><span class="o">:</span>        <span class="nx">remote</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span>
            <span class="nx">args</span><span class="o">:</span>           <span class="p">[</span> <span class="nx">portal</span><span class="p">,</span> <span class="nx">port</span> <span class="p">],</span>
            <span class="nx">restart</span><span class="o">:</span>        <span class="nx">activity</span><span class="p">.</span><span class="nx">Supervisor</span><span class="p">.</span><span class="nx">restart</span><span class="p">.</span><span class="nx">always</span><span class="p">,</span>
            <span class="nx">restart_limit</span><span class="o">:</span>  <span class="mi">5</span><span class="p">,</span>
            <span class="nx">restart_period</span><span class="o">:</span> <span class="mi">5000</span>
          <span class="p">}</span>
        <span class="p">)</span>
      <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listener_supervisor</span><span class="p">.</span><span class="nx">START</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="nx">EXIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;Listener&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">portal</span><span class="p">,</span> <span class="nx">port</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">REQUEST</span><span class="p">.</span><span class="nx">sync</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">portal</span> <span class="o">=</span> <span class="nx">portal</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">request_handler_supervisor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span> <span class="k">new</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">Supervisor</span><span class="p">()</span> <span class="p">);</span>
      
    <span class="p">},</span>
    
    <span class="nx">REQUEST</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">RequestHandler</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">portal</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">);</span>
      
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> 
        <span class="kd">function</span><span class="p">(</span> <span class="nx">chunk</span> <span class="p">)</span> <span class="p">{</span> 
          <span class="nx">handler</span><span class="p">.</span><span class="nx">REQUEST_DATA</span><span class="p">(</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="p">);</span> 
        <span class="p">}</span> 
      <span class="p">);</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">REQUEST_END</span> <span class="p">);</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">REQUEST_CLOSE</span> <span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="p">}</span> <span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">request_handler_supervisor</span><span class="p">.</span><span class="nx">SUPERVISE</span><span class="p">(</span> <span class="nx">handler</span> <span class="p">);</span>
      
    <span class="p">},</span>
    
    <span class="nx">EXIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
    <span class="p">}</span>
    
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;RequestHandler&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">portal</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">portal</span> <span class="o">=</span> <span class="nx">portal</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">req</span> <span class="o">=</span> <span class="nx">req</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">res</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">errorResponse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">text</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span> <span class="s1">&#39;error-response&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">status</span><span class="o">:</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">text</span> <span class="p">}</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
      <span class="p">}</span>
    
    <span class="p">},</span>
    
    <span class="nx">REQUEST_CLOSE</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">err</span><span class="o">:</span> <span class="nx">err</span> <span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">REQUEST_DATA</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">chunk</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">REQUEST_END</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">portal</span><span class="p">.</span><span class="nx">GET_PUBLISHED</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">GOT_PUBLISHED</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">GOT_PUBLISHED</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">errorResponse</span><span class="p">(</span> <span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;No toddick has been published with the url &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="k">switch</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="p">)</span> <span class="p">{</span>
        
        <span class="k">case</span> <span class="s1">&#39;GET&#39;</span><span class="o">:</span>
        
          <span class="k">if</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span> <span class="s1">&#39;accept&#39;</span> <span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;application/json&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">errorResponse</span><span class="p">(</span> <span class="mi">406</span><span class="p">,</span> <span class="s1">&#39;Accept is not application/json&#39;</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
          <span class="p">}</span>
          
          <span class="k">this</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">proxy_def</span> <span class="p">}</span> <span class="p">);</span>
          
          <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">proxy_def</span> <span class="p">)</span> <span class="p">);</span>
          
          <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
          
        <span class="k">case</span> <span class="s1">&#39;POST&#39;</span><span class="o">:</span>
        
          <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;application/json&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">errorResponse</span><span class="p">(</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;content-type is not application/json&#39;</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
          <span class="p">}</span>
          
          <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
          
          <span class="k">this</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="p">);</span>
          <span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">exception</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span> <span class="s1">&#39;json-error&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">exception</span><span class="o">:</span> <span class="nx">exception</span> <span class="p">}</span> <span class="p">);</span>
          <span class="p">}</span>
          
          <span class="k">this</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span> <span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">content</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span> <span class="p">}</span> <span class="p">);</span>
          
          <span class="k">if</span> <span class="p">(</span> 
            <span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span>
            <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">name</span>
            <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">name</span> <span class="p">]</span>
            <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">args</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">args</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span>
          <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">errorResponse</span><span class="p">(</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;The posted message content is invalid&#39;</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
          <span class="p">}</span>
          
          <span class="k">this</span><span class="p">.</span><span class="nx">task_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">PROCESS_ARGS</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">args</span> <span class="p">);</span>
          
          <span class="k">break</span><span class="p">;</span>
        
        <span class="k">default</span><span class="o">:</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">errorResponse</span><span class="p">(</span> <span class="mi">405</span><span class="p">,</span> <span class="s1">&#39;Method is not POST or GET&#39;</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
        
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">PROCESS_ARGS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
        <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="p">)</span> <span class="p">{</span>
          
          <span class="k">if</span><span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">is_toddick_proxy</span> <span class="p">)</span> <span class="p">{</span>
            
            <span class="k">this</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s1">&#39;proxy def&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span> <span class="p">}</span> <span class="p">);</span> 
            
            <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">portal</span><span class="p">.</span><span class="nx">PROXY</span><span class="p">(</span> 
              <span class="nx">value</span><span class="p">,</span> 
              <span class="k">this</span><span class="p">.</span><span class="nx">SET_PROXY_ARG</span><span class="p">.</span><span class="nx">withArgs</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">message</span> <span class="p">)</span> 
            <span class="p">);</span>
            
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            
            <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">PROCESS_ARGS</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
            
          <span class="p">}</span>
          
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="o">--</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">SEND_MESSAGE</span><span class="p">();</span>
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">SET_PROXY_ARG</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">arg_name</span><span class="p">,</span> <span class="nx">message_name</span><span class="p">,</span> <span class="nx">proxy</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">message_name</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">proxy</span><span class="p">[</span> <span class="nx">message_name</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
          <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span><span class="p">;</span>
          <span class="nx">proxy</span><span class="p">.</span><span class="nx">__ADD_PROXY_MESSAGE__</span><span class="p">(</span>
            <span class="nx">message_name</span><span class="p">,</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">SET_PROXY_ARG</span><span class="p">.</span><span class="nx">withArgs</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">arg_name</span><span class="p">,</span> <span class="nx">message_name</span><span class="p">,</span> <span class="nx">proxy</span> <span class="p">)</span>
          <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">args</span><span class="p">[</span> <span class="nx">arg_name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">proxy</span><span class="p">[</span> <span class="nx">message_name</span> <span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">[</span> <span class="nx">arg_name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">proxy</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="o">--</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">SEND_MESSAGE</span><span class="p">();</span>
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">SEND_MESSAGE</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">name</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">args</span> <span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">204</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
      
    <span class="p">},</span>
    
    <span class="nx">EXIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="nx">reason</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">errorResponse</span><span class="p">(</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;internal server error&#39;</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
    <span class="p">}</span>
    
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;ProxyFactory&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">portal</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">portal</span> <span class="o">=</span> <span class="nx">portal</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">proxy_def_request_supervisor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">Supervisor</span><span class="p">(</span>
          <span class="p">{</span>
            <span class="nx">toddick</span><span class="o">:</span>       <span class="nx">remote</span><span class="p">.</span><span class="nx">ProxyDefRequest</span><span class="p">,</span>
            <span class="nx">restart</span><span class="o">:</span>       <span class="nx">activity</span><span class="p">.</span><span class="nx">Supervisor</span><span class="p">.</span><span class="nx">restart</span><span class="p">.</span><span class="nx">on_error</span><span class="p">,</span>
            <span class="nx">restart_limit</span><span class="o">:</span> <span class="mi">5</span>
          <span class="p">}</span>
        <span class="p">)</span>
      <span class="p">);</span>
      
    <span class="p">},</span>
    
    <span class="nx">PROXY_FROM_URL</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">MSG</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">proxy_def_request_supervisor</span><span class="p">.</span><span class="nx">START</span><span class="p">(</span>
        <span class="nx">url</span><span class="p">,</span> 
        <span class="k">this</span><span class="p">.</span><span class="nx">PROXY_FROM_DEF</span><span class="p">.</span><span class="nx">withArgs</span><span class="p">(</span> <span class="nx">MSG</span> <span class="p">),</span> 
        <span class="k">this</span><span class="p">.</span><span class="nx">NO_DEF</span><span class="p">.</span><span class="nx">withArgs</span><span class="p">(</span> <span class="nx">MSG</span> <span class="p">)</span> 
      <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">PROXY_FROM_DEF</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">MSG</span><span class="p">,</span> <span class="nx">def</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">MSG</span><span class="p">(</span> <span class="k">new</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">Proxy</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">portal</span><span class="p">,</span> <span class="nx">def</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">NO_DEF</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">MSG</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">MSG</span><span class="p">(</span> <span class="k">new</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">FailedProxy</span><span class="p">(</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
    
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;FailedProxy&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;Proxy&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">portal</span><span class="p">,</span> <span class="nx">def</span><span class="p">)</span> <span class="p">{</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">portal</span> <span class="o">=</span> <span class="nx">portal</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">message_sender_supervisor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">activity</span><span class="p">.</span><span class="nx">Supervisor</span><span class="p">(</span>
          <span class="p">{</span>
            <span class="nx">toddick</span><span class="o">:</span>       <span class="nx">remote</span><span class="p">.</span><span class="nx">MessageSender</span><span class="p">,</span>
            <span class="nx">restart</span><span class="o">:</span>       <span class="s1">&#39;on-error&#39;</span><span class="p">,</span>
            <span class="nx">restart_count</span><span class="o">:</span> <span class="mi">4</span>
          <span class="p">}</span>
        <span class="p">)</span>
      <span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">addMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">message_name</span> <span class="p">)</span> <span class="p">{</span>    
        <span class="k">this</span><span class="p">.</span><span class="nx">defineMessage</span><span class="p">(</span> <span class="nx">message_name</span><span class="p">,</span> 
          <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">message_sender_supervisor</span><span class="p">.</span><span class="nx">START</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">portal</span><span class="p">,</span> <span class="nx">def</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">message_name</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">);</span>
      <span class="p">};</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">def</span><span class="p">.</span><span class="nx">messages</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">def</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">def</span><span class="p">.</span><span class="nx">message</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">(</span> <span class="nx">def</span><span class="p">.</span><span class="nx">message</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">(</span> <span class="s1">&#39;EXIT&#39;</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">(</span> <span class="s1">&#39;MONITOR_ADD&#39;</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">(</span> <span class="s1">&#39;MONITOR_REMOVE&#39;</span> <span class="p">);</span>
      
    <span class="p">},</span>
    
    <span class="nx">__ADD_PROXY_MESSAGE__</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">message_name</span><span class="p">,</span> <span class="nx">MSG</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">[</span> <span class="nx">message_name</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">addMessage</span><span class="p">(</span> <span class="nx">message_name</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">MSG</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="nx">__PROXY_EXIT__</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
    <span class="p">}</span>
      
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;MessageSender&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">portal</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">message_name</span><span class="p">,</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">portal</span> <span class="o">=</span> <span class="nx">portal</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="nx">message_name</span><span class="p">,</span>
        <span class="nx">args</span><span class="o">:</span> <span class="nx">args</span>
      <span class="p">};</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">task_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">PROCESS_ARGS</span><span class="p">(</span> <span class="nx">args</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">SEND_MESSAGE</span><span class="p">();</span>
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">PROCESS_ARGS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
        
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
        
        <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="p">)</span> <span class="p">{</span>
          
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;is object&quot;</span><span class="p">);</span>
          
          <span class="k">if</span><span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">is_toddick</span> <span class="p">)</span> <span class="p">{</span>
            
            <span class="k">if</span><span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">proxy_def</span> <span class="p">)</span> <span class="p">{</span>
              
              <span class="nx">args</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">proxy_def</span><span class="p">;</span>
              
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              
              <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">portal</span><span class="p">.</span><span class="nx">PUBLISH</span><span class="p">(</span> 
                <span class="s1">&#39;/arg/&#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> 
                <span class="nx">value</span><span class="p">,</span> 
                <span class="k">this</span><span class="p">.</span><span class="nx">SET_TODDICK_ARG</span><span class="p">.</span><span class="nx">withArgs</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span>
              <span class="p">);</span>
              
            <span class="p">}</span>
            
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">PROCESS_ARGS</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
          <span class="p">}</span>
           
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
          
          <span class="k">if</span><span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">is_toddick_message</span> <span class="p">)</span> <span class="p">{</span>
            
            <span class="k">if</span><span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">proxy_def</span> <span class="p">)</span> <span class="p">{</span>
              
              <span class="nx">args</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">proxy_def</span><span class="p">;</span>
              
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              
              <span class="k">if</span><span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toddick</span><span class="p">.</span><span class="nx">proxy_def</span> <span class="p">)</span> <span class="p">{</span>
                
                <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">SET_MESSAGE_ARG</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
                
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                
                <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">portal</span><span class="p">.</span><span class="nx">PUBLISH</span><span class="p">(</span>
                  <span class="s1">&#39;/arg/&#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toddick</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                  <span class="nx">value</span><span class="p">.</span><span class="nx">toddick</span><span class="p">,</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">SET_MESSAGE_ARG</span><span class="p">.</span><span class="nx">withArgs</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span>
                <span class="p">);</span>
                
              <span class="p">}</span>
              
            <span class="p">}</span>
          <span class="p">}</span>
            
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="o">--</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">SEND_MESSAGE</span><span class="p">();</span>
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">SET_TODDICK_ARG</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">arg_name</span><span class="p">,</span> <span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="nx">args</span><span class="p">[</span> <span class="nx">arg_name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">proxy_def</span><span class="p">;</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="o">--</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">SEND_MESSAGE</span><span class="p">();</span>
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">SET_MESSAGE_ARG</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">arg_name</span><span class="p">,</span> <span class="nx">msg</span> <span class="p">)</span> <span class="p">{</span>
      
      <span class="nx">msg</span><span class="p">.</span><span class="nx">proxy_def</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">is_toddick_proxy</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">toddick</span><span class="p">.</span><span class="nx">proxy_def</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
        <span class="nx">message</span><span class="o">:</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">message_name</span>
      <span class="p">};</span>
      
      <span class="nx">args</span><span class="p">[</span> <span class="nx">arg_name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">proxy_def</span><span class="p">;</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="o">--</span><span class="k">this</span><span class="p">.</span><span class="nx">task_count</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">SEND_MESSAGE</span><span class="p">();</span>
      <span class="p">}</span>
      
    <span class="p">},</span>
    
    <span class="nx">SEND_MESSAGE</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span> <span class="k">new</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
    
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;ProxyDefRequest&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">MSG</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span> <span class="k">new</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">MSG</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">toddick</span><span class="p">(</span> <span class="s1">&#39;Client&#39;</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span>
  <span class="p">{</span>
    
    <span class="nx">INIT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">requrl</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">MSG</span><span class="p">)</span> <span class="p">{</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">MSG</span> <span class="o">=</span> <span class="nx">MSG</span><span class="p">;</span>
      
      <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">requrl</span><span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">host</span><span class="o">:</span>    <span class="nx">parsed</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
        <span class="nx">port</span><span class="o">:</span>    <span class="nx">parsed</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
        <span class="nx">path</span><span class="o">:</span>    <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span>
        <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">&#39;accept&#39;</span> <span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="p">}</span>
      <span class="p">};</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">content</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">;</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">req</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">RESPONSE</span><span class="p">.</span><span class="nx">sync</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">.</span><span class="nx">sync</span> <span class="p">);</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="nx">content</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span> <span class="s1">&#39;sent&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">content</span> <span class="p">}</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">content</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span> <span class="k">new</span> <span class="nx">timer</span><span class="p">.</span><span class="nx">Timeout</span><span class="p">(</span> <span class="mi">5000</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">TIMEOUT</span> <span class="p">)</span> <span class="p">);</span>
      
    <span class="p">},</span>
    
    <span class="nx">TIMEOUT</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="s1">&#39;timeout&#39;</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">ERROR</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">error</span><span class="o">:</span> <span class="nx">error</span><span class="p">}</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">RESPONSE</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        
      <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">res</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">DATA</span><span class="p">.</span><span class="nx">sync</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">END</span><span class="p">.</span><span class="nx">sync</span><span class="p">);</span>
      
    <span class="p">},</span>
    
    <span class="nx">DATA</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">END</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">204</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="s1">&#39;response-status&#39;</span><span class="p">,</span> 
          <span class="p">{</span> 
            <span class="nx">statusCode</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> 
            <span class="nx">headers</span><span class="o">:</span>    <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
            <span class="nx">content</span><span class="o">:</span>    <span class="k">this</span><span class="p">.</span><span class="nx">content</span>
          <span class="p">}</span>
        <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">===</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;application/json&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="s1">&#39;response-content-type&#39;</span><span class="p">,</span>
          <span class="p">{</span> 
            <span class="nx">statusCode</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> 
            <span class="nx">headers</span><span class="o">:</span>    <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
            <span class="nx">content</span><span class="o">:</span>    <span class="k">this</span><span class="p">.</span><span class="nx">content</span>
          <span class="p">}</span>
        <span class="p">);</span>
      <span class="p">}</span>
  
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">result</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span> <span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">result</span> <span class="p">}</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">exception</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="s1">&#39;content-parse&#39;</span><span class="p">,</span>
            <span class="p">{</span>
              <span class="nx">content</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
              <span class="nx">exception</span><span class="o">:</span> <span class="nx">exception</span>
            <span class="p">}</span>
          <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">if</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">MSG</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">MSG</span><span class="p">(</span> <span class="nx">result</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
      
    <span class="p">}</span>
    
  <span class="p">}</span>
<span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 